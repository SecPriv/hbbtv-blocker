In the following, you can find the instructions to analyze the TV channels pcaps. The scripts are described in order of execution. **They might need a little adjustement to be run on the 4 parts of pcap**.

## `dns_mapping.py`
This script reads the pcaps and extracts DNS queries. It returns a dictionary with IPs mapped to domain names that will later be used.

Change `base_folder = '../'` to where your pcaps are stored. Also change `json.dump(dns_map, open('../dns_mapping/' + file_name + '.json', 'w+'))` to where you want your json dictionaries to be stored (and create a folder names `dns_mapping/`). The name of the json file is the same as the pcap.

## `extract_ips_and_timeframe.py`

This script reads the pcaps and extracts IPs and the relative time (0 when the pcap starts and then incrementing). It returns a dictionary with IPs mapped to consent statuses based on which time window it belongs to. This needs to be changed in case of multiple files to read the different pcaps and recognize that as the consent statuses rather than time. 

Change `base_folder = '../'` to where your pcaps are stored. Also change `json.dump(ip_and_time, open('../consent_status/' + file_name + '.json', 'w+'))` to where you want your json dictionaries to be stored (and create a folder names `consent_status/`). The name of the json file is the same as the pcap.

## `map_ip_to_domainname.py`

This scripts takes as input the files contained in `dns_mapping/` and the files contained in `consent_status/` and maps IPs to domainnames. It returns a new map that can be saved in `full_analysis/`. Change `files = []` to the names of your files. 

## `overlapping_domains.py`

This scripts takes as input the files contained in `full_analysis/` and checks which domains are present in more than a specific number of traffic captures. This is done to check if some domains are generated by the Smart TV rather than the HbbTV app. Change `files = []` to the names of your files. 

## `extract_domains_before_consent.py`

This scripts takes as input the files contained in `full_analysis/` and checks which domains are found before consent is given (In case of multiple files the domains contained in file `_1`). Change `files = []` to the names of your files. Change `to_exclude = []` to include the domains outputted by `overlapping_domains.py`. Change `json.dump(before_consent, open('../full_analysis/domains_before_consent/' + file + '.json', 'w+'))` to where you want your json dictionaries to be stored (and create a folder names `domains_before_consent/`). The name of the json file is the same as the pcap.

## `check_intersection_with_easylist.py`

Checks the intersection of the domains found before consent with EasyList (https://easylist.to/). Change `files = []` to the names of your files. 

**PART 1** (now commented) checks the intersection with the list present in `blocklist/easylist/*` (the files name needs to be changed manually). Change `base_path = ''` to where the lists mentioned above are. And `easylist = [x.strip() for x in open(base_path + 'easylist/easylist_annoyance_27_05_2022.txt', 'r').readlines()]` here you need yo change the file name to the three different files present in `blocklist/easylist/`.

**PART 2** checks the intersection with the list uploaded in the OwnCloud I shared. Change `base_path_old_lists = ''` to where the lists mentioned above are downloaded.

It outputs the "blocked" domains for each channel. I saved that information in a txt file but a more structured way to save this might be also needed. (TODO for now)

## `check_intersection_with_pihole.py`

Checks the intersection of the domains found before consent with PiHole lists. Change `files = []` to the names of your files. 

Checks the intersection with the list present in `blocklist/pihole/*`.

It outputs the "blocked" domains for each channel. I saved that information in a txt file but a more structured way to save this might be also needed. (TODO for now)

